<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner un Ticket</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        #reader { width: 300px; margin: auto; }
        #result { margin-top: 20px; font-size: 1.2em; }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="../static/images/logo2.png" type="image/x-icon">
</head>
<body class="bg-gray-100 text-gray-800">

    {% include '/components/nav.html' %}
    <h2 class="text-2xl font-bold text-center mt-6 mb-4">Scanner un ticket</h2>

    <div class="flex flex-col items-center">
        <div id="reader" class="w-80"></div>
        <div id="result" class="mt-6 text-center"></div>
    </div>

    <!-- Modal de résultat -->
    <div id="resultModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div id="modalContainer" class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center border-l-4">
            <h3 id="modalTitle" class="text-2xl font-bold mb-4"></h3>
            <div id="modalContent" class="mb-6 text-lg"></div>
            <button onclick="closeModal()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded-lg transition w-full">
                Scanner le suivant
            </button>
        </div>
    </div>

    {% include '/components/flash.html' %}
    <script>
    let html5QrcodeScanner = null;
    let isScanning = false; // Flag pour empêcher les scans multiples

    function onScanSuccess(decodedText) {
        // Si un scan est déjà en cours, on ignore les autres détections
        if (isScanning) {
            return;
        }

        isScanning = true;

        // Pause le scanner immédiatement
        html5QrcodeScanner.pause(true);

        document.getElementById("result").innerHTML = "Vérification du ticket...";

        // Appel au serveur Flask pour vérifier la validité du ticket
        fetch("/check_ticket/" + decodedText)
            .then(response => response.json())
            .then(data => {
                showResultModal(data, decodedText);
            })
            .catch(error => {
                console.error("Erreur :", error);
                showResultModal({ valid: false, message: "Erreur de connexion" }, decodedText);
            });
    }

    function showResultModal(data, uuid) {
        const modalTitle = document.getElementById("modalTitle");
        const modalContent = document.getElementById("modalContent");
        const modalContainer = document.getElementById("modalContainer");
        const modal = document.getElementById("resultModal");

        if (data.valid === true) {
            const snd = new Audio("{{ url_for('static', filename='sounds/success.mp3') }}");
            snd.currentTime = 0;
            snd.play();
            modalTitle.textContent = "✅ Ticket Valide";
            modalTitle.className = "text-2xl font-bold mb-4 text-green-600";
            modalContainer.className = "bg-green-300 rounded-xl p-8 max-w-md w-full mx-4 text-center";
            modalContent.innerHTML = `
                <p><strong>Nom :</strong> ${data.nom} ${data.prenom}</p>
                <p><strong>Catégorie :</strong> ${data.categorie}</p>
                <p><strong>Statut :</strong> Accepté - Ticket marqué comme utilisé</p>
            `;
        } else if (data.valid === false) {
            if (data.type === "date_invalid") {
                const snd = new Audio("{{ url_for('static', filename='sounds/error.mp3') }}");
                snd.currentTime = 0;
                snd.play();
                modalTitle.textContent = "⚠️ Date Incorrecte";
                modalTitle.className = "text-2xl font-bold mb-4 text-orange-600";
                modalContainer.className = "bg-orange-300 rounded-xl p-8 max-w-md w-full mx-4 text-center";
                modalContent.innerHTML = `
                    <p><strong>Raison :</strong> ${data.message}</p>
                `;
            } else {
                const snd = new Audio("{{ url_for('static', filename='sounds/error.mp3') }}");
                snd.currentTime = 0;
                snd.play();
                modalTitle.textContent = "❌ Ticket Invalide";
                modalTitle.className = "text-2xl font-bold mb-4 text-red-600";
                modalContainer.className = "bg-red-300 rounded-xl p-8 max-w-md w-full mx-4 text-center";
                const reason = data.message || "Raison inconnue";
                modalContent.innerHTML = `
                    <p><strong>Raison :</strong> ${reason}</p>
                `;
            }
        } else {
            const snd = new Audio("{{ url_for('static', filename='sounds/error.mp3') }}");
            snd.currentTime = 0;
            snd.play();
            modalTitle.textContent = "⚠️ Erreur";
            modalTitle.className = "text-2xl font-bold mb-4 text-yellow-600";
            modalContainer.className = "bg-yellow-300 rounded-xl p-8 max-w-md w-full mx-4 text-center";
            modalContent.innerHTML = `
                <p>Une erreur est survenue lors de la vérification.</p>
                <p><strong>Message :</strong> ${data.message || "Erreur inconnue"}</p>
            `;
        }

        document.getElementById("result").innerHTML = "";
        modal.classList.remove("hidden");
    }

    function closeModal() {
        const modal = document.getElementById("resultModal");
        modal.classList.add("hidden");
        isScanning = false;
        html5QrcodeScanner.resume(); // Reprend le scanning
    }

    // Fermer la modal en cliquant en dehors
    document.getElementById("resultModal").addEventListener("click", function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    html5QrcodeScanner = new Html5QrcodeScanner(
        "reader",
        { fps: 10, qrbox: 250 },
        false
    );

    html5QrcodeScanner.render(onScanSuccess);
    </script>

</body>
</html>
